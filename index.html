<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mobile ICU Arrhythmia Simulator – Clean & Perfect</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  html,body{height:100%;width:100%;background:#000;overflow:hidden;font-family:'Segoe UI',sans-serif;}
  #monitor{
    display:grid;height:100vh;padding:4px;gap:4px;
    grid-template-columns:1fr 1fr;
    grid-template-rows:120px 120px 120px auto auto auto auto;
    background:#000;
  }
  .waveform,.param{
    background:#001122;border-radius:12px;overflow:hidden;
    box-shadow:0 0 20px rgba(0,255,255,0.3);border:1px solid #004466;
  }
  .waveform{background:#000;}
  canvas{width:100%;height:100%;display:block;}
  .param{display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;}
  .label{font-size:3vw;color:#00ffff;opacity:0.9;letter-spacing:1px;font-weight:600;}
  .value{font-size:12vw;color:#00ffff !important;font-weight:900;line-height:1;
    text-shadow:0 0 30px #0ff, 0 0 60px #0ff;font-variant-numeric:tabular-nums;}
  .unit{font-size:3.5vw;color:#00ffff;opacity:0.9;margin-top:4px;font-weight:600;}
  .abp-row{display:flex;align-items:baseline;gap:6px;}
  .slash{font-size:10vw;color:#00ffff;opacity:0.9;margin-top:-6px;}
  .alarm{color:#ff3366 !important;text-shadow:0 0 30px #f33, 0 0 60px #f33 !important;animation:blink 0.8s infinite;}
  @keyframes blink{50%{opacity:0.4;}}

  /* FIXED: Control panel now slides up from bottom without covering anything */
  #controls{
    position:fixed;bottom:-300px;left:50%;transform:translateX(-50%);z-index:1000;
    width:92vw;max-width:420px;background:rgba(0,15,35,0.98);padding:14px 10px;
    border-radius:20px;border:2px solid #0ff;box-shadow:0 0 40px rgba(0,255,255,0.7);
    transition:bottom 0.4s cubic-bezier(0.2,0.8,0.2,1);
    display:flex;flex-wrap:wrap;gap:10px;justify-content:center;
  }
  #controls.show{bottom:16px;}
  #toggleBtn{
    position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:999;
    background:#001122;border:2px solid #0ff;border-radius:50px;padding:12px 30px;
    color:#0ff;font-weight:bold;font-size:4.5vw;box-shadow:0 0 30px #0ff;
    cursor:pointer;transition:all 0.3s;
  }
  #toggleBtn:active{transform:translateX(-50%) scale(0.9);}
  button{
    padding:12px 16px;background:#001122;border:2px solid #0ff;border-radius:14px;
    color:#0ff;font-weight:bold;font-size:4.2vw;min-width:88px;cursor:pointer;
  }
  button:active{background:#004466;transform:scale(0.95);}

  @media (orientation:landscape){
    #monitor{grid-template-columns:1fr 1fr 1fr 1fr;grid-template-rows:100px 100px auto auto;}
    .value{font-size:9.5vw;}
  }
</style>
</head>
<body>

<div id="monitor">
  <div class="waveform" id="ecg"></div>
  <div class="waveform" id="spo2"></div>
  <div class="waveform" id="capno"></div>
  <div class="waveform" id="abp"></div>

  <div class="param"><div class="label">HR</div><div class="value" id="hr">72</div><div class="unit">bpm</div></div>
  <div class="param"><div class="label">SpO₂</div><div class="value" id="oxy">97</div><div class="unit">%</div></div>
  <div class="param"><div class="label">EtCO₂</div><div class="value" id="etco2">36</div><div class="unit">mmHg</div></div>
  <div class="param"><div class="label">RR</div><div class="value" id="rr">16</div><div class="unit">br/min</div></div>

  <div class="param">
    <div class="label">ABP</div>
    <div class="abp-row">
      <div class="value" id="abp-sys">116</div>
      <div class="slash">/</div>
      <div class="value" id="abp-dia">68</div>
    </div>
    <div class="unit">mmHg</div>
  </div>

  <div class="param"><div class="label">MAP</div><div class="value" id="map">84</div><div class="unit">mmHg</div></div>
  <div class="param"><div class="label">NIBP</div><div class="value" id="bp">116/68</div><div class="unit">mmHg</div></div>
  <div class="param"><div class="label">Temp</div><div class="value" id="temp">37.0</div><div class="unit">°C</div></div>
</div>

<!-- Clean slide-up control panel -->
<div id="toggleBtn" onclick="document.getElementById('controls').classList.toggle('show')">
  ▼ Arrhythmias ▼
</div>

<div id="controls">
  <button onclick="setRhythm('nsr')">NSR</button>
  <button onclick="setRhythm('afib')">A-Fib</button>
  <button onclick="setRhythm('svt')">SVT</button>
  <button onclick="setRhythm('vtach')">VTach</button>
  <button onclick="setRhythm('vfib')">VFib/Asys</button>
  <button onclick="setRhythm('pvc')">PVCs</button>
</div>

<script>
const canvases = {}, ctxs = {};
['ecg','spo2','capno','abp'].forEach(id => {
  const canvas = document.createElement('canvas');
  document.getElementById(id).appendChild(canvas);
  canvases[id] = canvas;
  ctxs[id] = canvas.getContext('2d', { alpha: false });
});

function resize() {
  Object.keys(canvases).forEach(id => {
    const rect = canvases[id].parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvases[id].width = rect.width * dpr;
    canvases[id].height = rect.height * dpr;
  });
}
resize(); window.addEventListener('resize', resize);

let t = 0, lastTime = 0;
let rhythm = 'nsr';

function setRhythm(r) {
  rhythm = r;
  document.getElementById('controls').classList.remove('show'); // auto-hide after selection
}

function animate(now) {
  if (!lastTime) lastTime = now;
  const delta = now - lastTime;
  lastTime = now;
  t += delta * 0.06;

  drawECG(); drawPleth(); drawCapno(); drawABP();
  updateVitals();
  requestAnimationFrame(animate);
}

/* All waveform functions unchanged – ultra-realistic & smooth */
function drawECG() {
  const ctx = ctxs.ecg; const w = ctx.canvas.width, h = ctx.canvas.height;
  ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
  ctx.strokeStyle = '#0f0'; ctx.lineWidth = 3 * devicePixelRatio; ctx.beginPath();
  const baseHR = rhythm === 'svt' ? 180 : rhythm === 'vtach' ? 160 : rhythm === 'afib' ? 100 : 72;
  const interval = 60000 / baseHR;
  for (let i = 0; i < w; i++) {
    let ms = t * 0.06 * 1000 + i * (interval / w * 1.3);
    let phase = (ms % interval) / interval;
    if (rhythm === 'afib') phase = (ms + Math.sin(ms/200)*150 + Math.random()*80) % interval / interval;
    if (rhythm === 'vfib') {
      if ((t*0.06*1000) % 10000 < 6000) {
        ctx.lineTo(i, h/2 + Math.sin(ms/8)*h*0.4 + (Math.random()-0.5)*h*0.6); continue;
      } else { ctx.lineTo(i, h/2 + (Math.random()-0.5)*h*0.02); continue; }
    }
    let y = h/2;
    if (rhythm === 'vtach') { y += Math.sin(phase * Math.PI * 2) * h * 0.7; }
    else {
      const isPVC = rhythm === 'pvc' && Math.floor(ms/interval) % 11 === 8;
      if (isPVC) { y += Math.sin((phase*2-0.5)*Math.PI) * h * 0.7 + h * 0.25; }
      else {
        if (phase > 0.05 && phase < 0.20 && rhythm !== 'svt') y -= Math.sin((phase-0.05)/0.15*Math.PI)*h*0.09;
        if (phase > 0.35 && phase < 0.39) y -= Math.exp(-Math.pow((phase-0.37)*45,2))*h*0.92;
        if (phase > 0.39 && phase < 0.44) y += Math.sin((phase-0.39)/0.05*Math.PI)*h*0.55;
        if (phase > 0.56 && phase < 0.88) y -= Math.pow(Math.sin((phase-0.56)/0.32*Math.PI),1.6)*h*0.34;
      }
    }
    y += Math.sin(t/300)*h*0.06 + (Math.random()-0.5)*h*0.008;
    i===0 ? ctx.moveTo(i,y) : ctx.lineTo(i,y);
  }
  ctx.stroke();
}

/* Other waveforms (Pleth, Capno, ABP) – unchanged, super smooth */
function drawPleth() { /* same as before */ const ctx=ctxs.spo2; const w=ctx.canvas.width,h=ctx.canvas.height; ctx.fillStyle='#000';ctx.fillRect(0,0,w,h); ctx.strokeStyle='#0ff';ctx.lineWidth=4*devicePixelRatio;ctx.beginPath(); const resp=Math.sin(t/300)*0.15; for(let i=0;i<w;i++){ const cycle=rhythm==='vtach'||rhythm==='vfib'?0.5:((t+i*0.78)/(rhythm==='svt'?40:72))%1; let y=h*0.72; if(cycle<0.35)y-=Math.pow(cycle/0.35,0.6)*h*0.42*(1+resp); else if(cycle<0.45)y-=h*0.42*(1+resp)-Math.pow((cycle-0.35)/0.1,0.5)*h*0.12; else if(cycle<0.55)y-=h*0.42*(1+resp)-h*0.12+Math.pow((cycle-0.45)/0.1,0.5)*h*0.08; else y+=Math.pow((cycle-0.55)/0.45,0.8)*h*0.55; y+=(Math.random()-0.5)*h*0.006; i===0?ctx.moveTo(i,y):ctx.lineTo(i,y); } ctx.stroke(); }
function drawCapno() { const ctx=ctxs.capno; const w=ctx.canvas.width,h=ctx.canvas.height; ctx.fillStyle='#000';ctx.fillRect(0,0,w,h); ctx.strokeStyle='#ff0';ctx.lineWidth=4*devicePixelRatio;ctx.beginPath(); for(let i=0;i<w;i++){ const cycle=((t+i*0.8)/160)%1; let y=h*0.88; if(cycle>0.08&&cycle<0.35)y-=Math.pow((cycle-0.08)/0.27,0.5)*h*0.62; else if(cycle>0.35&&cycle<0.78)y-=h*0.62+Math.sin((cycle-0.35)*Math.PI*0.8)*h*0.06; else if(cycle>0.78)y+=Math.pow((cycle-0.78)/0.22,0.5)*h*0.72; y+=(Math.random()-0.5)*h*0.005; i===0?ctx.moveTo(i,y):ctx.lineTo(i,y); } ctx.stroke(); }
function drawABP() { const ctx=ctxs.abp; const w=ctx.canvas.width,h=ctx.canvas.height; ctx.fillStyle='#000';ctx.fillRect(0,0,w,h); ctx.strokeStyle='#f44';ctx.lineWidth=4*devicePixelRatio;ctx.beginPath(); const resp=Math.sin(t/300)*0.12; for(let i=0;i<w;i++){ const cycle=rhythm==='vtach'||rhythm==='vfib'?0.5:((t+i*0.78)/(rhythm==='svt'?40:72))%1; let y=h*0.75; if(cycle<0.14)y-=Math.pow(cycle/0.14,0.6)*h*0.58*(1+resp); else if(cycle<0.28)y-=h*0.58*(1+resp)-Math.pow((cycle-0.14)/0.14,0.5)*h*0.18; else if(cycle<0.38)y+=Math.pow((cycle-0.28)/0.1,0.5)*h*0.25; else if(cycle<0.48)y-=Math.pow((cycle-0.38)/0.1,0.5)*h*0.15; else y+=Math.pow((cycle-0.48)/0.52,0.7)*h*0.78; y+=(Math.random()-0.5)*h*0.007; i===0?ctx.moveTo(i,y):ctx.lineTo(i,y); } ctx.stroke(); }

const els = { hr:document.getElementById('hr'), oxy:document.getElementById('oxy'), etco2:document.getElementById('etco2'), rr:document.getElementById('rr'), sys:document.getElementById('abp-sys'), dia:document.getElementById('abp-dia'), map:document.getElementById('map'), bp:document.getElementById('bp'), temp:document.getElementById('temp') };

function updateVitals() {
  const hr = rhythm === 'vtach' ? 160 : rhythm === 'svt' ? 180 : rhythm === 'vfib' ? 0 : rhythm === 'afib' ? Math.round(70 + Math.random()*70) : 72;
  els.hr.textContent = hr; els.hr.classList.toggle('alarm', hr < 50 || hr > 140);
  const sys = rhythm === 'vfib' ? 0 : Math.round(116 + Math.sin(t/70)*16 + (Math.random()-0.5)*8);
  const dia = rhythm === 'vfib' ? 0 : Math.round(68 + Math.sin(t/70)*12 + (Math.random()-0.5)*6);
  const mean = Math.round((sys + 2*dia)/3);
  els.sys.textContent = sys; els.dia.textContent = dia;
  els.map.textContent = mean; els.bp.textContent = `${sys}/${dia}`;
}

requestAnimationFrame(animate);
</script>
</body>
</html>